unit Unit1;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls;

type
  TForm1 = class(TForm)
    Label1: TLabel;
    Label2: TLabel;
    Button1: TButton;
    EdtUserId: TEdit;
    EdtPsw: TEdit;
    procedure Button1Click(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure crtMnuFrm();virtual;
  private
    { Private 宣言 }
    var
      wkCursor:TCursor;
  public
    { Public 宣言 }
  end;

var
  Form1: TForm1;

implementation

{$R *.dfm}

uses Utilybs, functions, IniFilemnt, DM2;

procedure TForm1.Button1Click(Sender: TObject);
var
  KGKB:String;//権限区分
  frm:TForm;
  PDevMode   : ^TDevMode;
begin

  EdtUserId.Color := clWindow;
  EdtPsw.Color := clWindow;

  try

    try
    //データモジュールを作成
      dmUtilYbs:=TdmUtilYbs.Create(self);//サーバー接続オン

      if dmUtilYbs.FDConnection1.Connected=true then  //接続できたら
      begin

        //パスワードチェック＆権限区分取得
        KGKB:=dmUtilYbs.PassMstChk(EdtUserId.Text,EdtPsw.Text);
        if KGKB = 'USERR' then
        begin
          EdtUserId.Color := clERR;
          EdtUserId.SetFocus;
          Exit;
        end else
        if KGKB = 'PAERR' then
        begin
          EdtPsw.Color := clERR;
          EdtPsw.SetFocus;
          Exit;
        end;

        if KGKB = 'EXERR' then
        begin
          EdtPsw.Color := clERR;
          EdtPsw.SetFocus;
          Exit;
        end;

        Screen.Cursor := wkCursor;

        dmUtilYbs.sUserName :=  EdtUserId.Text;
        //メニュー表示
        crtMnuFrm;      //継承のため、ファンクション化
//        if PGKChk('MNU1',KGKB) then
//        begin
//          frm := TMN001CFrm.Create(Application);
//          Self.Hide;
//          frm.ShowModal;
//        end;

        dmUtilYbs.FDConnection1.Connected:=false;
        close;

      end;

    Except on e:Exception do
    begin
      MessageDlg(E.Message, mtError, [mbOK], 0);
      abort;
    end;
    End;

  finally
    dmUtilYbs.Free;    //エラー時・パスワードチェックで引っかかった時にFree／正常時はPGM終了後にFree。
  end;

end;

procedure TForm1.crtMnuFrm;
var
  frm:TForm;
begin
//    frm := TMNK001Frm.Create(Application);
    Self.Hide;
    frm.ShowModal;
end;

procedure TForm1.FormShow(Sender: TObject);
begin
try
      EdtUserId.Text := inifilemnt.GetIniRemote(cSection_Common, cKey_UserName, '');     // サインオンユーザー名
      EdtPsw.Text    := inifilemnt.GetIniRemote(cSection_Common, cKey_PWD, '');          // サインオンパスワード

except

end;

end;

end.
